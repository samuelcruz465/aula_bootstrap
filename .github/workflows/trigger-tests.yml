name: Trigger and Wait for Playwright Tests (Repo A)

on:
  push:
    branches: ["test-pipe"]
  pull_request:
    branches: ["main"]

jobs:
  trigger-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger workflow in repo A
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PIPE }}
          script: |
            const owner = "samuelcruz465";
            const repo = "pw-pipeline";

            // 1. Disparar o workflow do Repositório A
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: "playwright.yml",  // nome EXATO do arquivo no repo A
              ref: "main"
            });

            console.log("Dispatched workflow in pw-pipeline.");

            // 2. Aguardar até o workflow terminar
            while (true) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: "playwright.yml",
                per_page: 1
              });

              const run = runs.data.workflow_runs[0];

              if (run && run.status === "completed") {

                console.log("Workflow finished with:", run.conclusion);

                if (run.conclusion !== "success") {
                  core.setFailed("❌ Playwright tests failed in pw-pipeline.");
                }

                break;
              }

              console.log("⏳ Waiting 10 seconds for completion...");
              await new Promise(resolve => setTimeout(resolve, 10000));
            }
